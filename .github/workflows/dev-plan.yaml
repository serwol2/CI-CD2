name: 'plan DEV'


on:
  #pull_request:
   push:
    branches:
     - feature
    # path:
    #   - terraform/**

env:
  AWS_ACCESS_KEY: ${{secrets.AWS_ACCESS_KEY_ID}}
  AWS_SECRET_KEY: ${{secrets.AWS_SECRET_KEY_ID}}
  GITHUB_TOKEN: ${{secrets.GITH_TOKEN}}
  #REGISTRY: ghcr.io


jobs:
#   make_stru_test:
#     name: running terraform plan and python lint
#     runs-on: ubuntu-latest
#     env:
#       WORKING_DIRECTORY: terraform
  
#     steps:
#       - name: 'Checkout'
#         uses: actions/checkout@master

#       - name: Configure AWS Credentials
#         uses: aws-actions/configure-aws-credentials@v1 
#         with:
#           aws-access-key-id: ${{env.AWS_ACCESS_KEY}}
#           aws-secret-access-key: ${{env.AWS_SECRET_KEY}}
#           aws-region: "us-east-1"

#       - name: 'Use terraform 1.1.7'
#         uses: hashicorp/setup-terraform@v1
#         with:
#           terraform_version: 1.1.7

#       - name: 'Terraform fmt'
#         id: fmt
#         run: terraform fmt -check
#         continue-on-error: true
#         working-directory: ${{ env.WORKING_DIRECTORY }}    

#       - name: 'Terraform init'
#         id: init
#         run: terraform init 
#         working-directory: ${{ env.WORKING_DIRECTORY }}

#       - name: 'Terraform plan'
#         id: plan
#         run: terraform plan -no-color
#         working-directory: ${{ env.WORKING_DIRECTORY }}

# python lint

#   flake8-lint:
#     runs-on: ubuntu-latest
#     name: Lint
#     steps:
#       - name: Check out source repository
#         uses: actions/checkout@v2
#       - name: Set up Python environment
#         uses: actions/setup-python@v2
#         with:
#           python-version: "3.8"
    #   - name: flake8 Lint
    #     uses: py-actions/flake8@v2   
    
#   build: 
#     runs-on: ubuntu-latest
#     name: Build and push Docker image to GitHub Packages


  docker-build-and-push:
    runs-on: ubuntu-latest
    name: docker build and push
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1


    #   - name: Login to DockerHub
    #     uses: docker/login-action@v1 
    #     with:
    #       username: ${{ secrets.DOCKERHUB_USERNAME }}
    #       password: ${{ secrets.DOCKERHUB_TOKEN }}
      
    #   - name: Build and push
    #     uses: docker/build-push-action@v2
    #     with:
    #       push: true
    #       tags: serwol/app:latest
          
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: serwol2 #${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
    #   - name: Build and push docker image
    #     uses: docker/build-push-action@v2
    #     with:
    #      # context: .

    #       push: true
    #       tags: serwol2/app:latest

      - name: Build and push docker image
        uses: mr-smithers-excellent/docker-build-push@v5
        with:
           image: image-name
           registry: ghcr.io
          #githubOrg: override-org # optional
           username: serwol2
           password: ${{ secrets.GITHUB_TOKEN }}



          
#         # labels: ${{ steps.meta.outputs.labels }}
#         uses: mr-smithers-excellent/docker-build-push@v5
# with:
#   image: image-name 
#   registry: ghcr.io
#   githubOrg: override-org # optional
#   username: ${{ secrets.GHCR_USERNAME }}
#   password: ${{ secrets.GHCR_TOKEN }}
    
# uses: mr-smithers-excellent/docker-build-push@v5
